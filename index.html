<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.8.0/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<style type="text/css">
* {
	font-family: 'Roboto', sans-serif;
}

div {
	text-align: center;
}

img {
	width: 100px;
}

h1 {
	font-size: 3em;
}

p {
	font-size: 1em;
	margin-bottom: 100px;
}

input {
	display: none;
}

label {
	border: 1px solid #ccc;
	border-radius: 0.25em;
    display: inline-block;
    padding: 20px 12px;
    cursor: pointer;
	background-color: #32C91A;
	box-shadow: inset 0 0 0.1em #fff, 0.2em 0.2em 0.2em rgba( 0, 0, 0, 0.1 );

	font-weight: 700;
	font-size: 2em;
}

#footer {
	position: absolute;
	bottom: 0;	
	margin-left: auto;
	margin-right: auto;
	left: 0;
	right: 0;
}

#teste {
	white-space: nowrap;
	justify-content: center;
}

#logotoo {
	width: 200px;
}

#logoti {
	width: 15px;
	display: inline-block;
}

h6 {
	font-size: 1em;
	display: inline-block;
}

#botao {
	margin-bottom: 100px;
}

#progressBar {
      width: 50%;
      height: 30px;
      background-color: #f2f2f2;
      border-radius: 4px;
      overflow: hidden;
	  margin: auto;
    }

#progressBar .progress {
    height: 100%;
    background-color: #32C91A;
    transition: width 0.2s ease-in-out;
}

.progressText {
	position: absolute;
	margin-left: auto;
	margin-right: auto;
	left: 0;
	right: 0;
}
</style>
</head>

<body>
	<div id="all">
		<h1>PDF para PNG</h1>
		<p id="texto">Converta as páginas de um arquivo PDF para arquivos de imagem PNG,
	   	<br>basta selecionar um arquivo e a conversão acontecerá em seguida</p>

		<div id="botao">
			<label id="label" for="pdfFileInput">SELECIONE UM ARQUIVO PDF</label>
			<input type="file" id="pdfFileInput" name="pdfFileInput" accept="application/pdf" />
		</div>

		<div id="progressBar" style="display: none;">
			<p class="progressText"></p>
			<div class="progress" style="width: 0;"></div>
		</div>

		<div id="footer">
			<div>
				<img id="logotoo" src="./LOGO MUNICIPIO2021.svg">
			</div>
			<div id="teste">
				<img id="logoti" src="./Logo do Dep. Tecnologia da Informação (TI)-13.svg">
				<h6>Departamento de Tecnologia da Informação</h6>
			</div>
		</div>
	</div>

	

	<div id="pdf-main-container">
	  <a id="download-images" href="#" download="pages.zip" style="display: none;">Download Images as ZIP</a>
	</div>

	<script>
		const pdfFileInput = document.querySelector("#pdfFileInput");
		const outroProgress = document.querySelector("#progressBar")
		const progressBar = document.querySelector("#progressBar .progress");
		const textoElemento = document.querySelector("#texto");

pdfFileInput.addEventListener("change", function(event) {
  pdfFileInput.style.display = "none";
  label.style.display = "none";
  outroProgress.style.display = "block";
  textoElemento.textContent = "Arquivo selecionado! Aguarde enquanto fazemos a conversão.";
});

function converterPDFParaImagens(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = function() {
      const typedArray = new Uint8Array(this.result);

      pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
        const totalPaginas = pdf.numPages;
        const zip = new JSZip();

        function converterPagina(pageIndex) {
          if (pageIndex >= totalPaginas) {
            zip.generateAsync({ type: "blob" }).then(function(content) {
              resolve(content);
            });
            return;
          }

          pdf.getPage(pageIndex + 1).then(function(page) {
            const scale = 2;
            const viewport = page.getViewport({ scale });

            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            const renderContext = {
              canvasContext: context,
              viewport: viewport
            };

            page.render(renderContext).promise.then(function() {
              const imageData = canvas.toDataURL("image/png");
              zip.file(`pagina_${pageIndex + 1}.png`, imageData.substr(imageData.indexOf(',') + 1), { base64: true });

              const progressoAtual = pageIndex + 1;
              const progressoTotal = (progressoAtual / totalPaginas) * 100;
              progressBar.style.width = progressoTotal + "%";
              console.log("Progresso: " + progressoTotal + "%");

              converterPagina(pageIndex + 1);
            });
          });
        }

        converterPagina(0);
      });
    };

    reader.onerror = function() {
      reject(new Error('Falha ao ler o arquivo.'));
    };

    reader.readAsArrayBuffer(file);
  });
}

const fileInput = document.querySelector("#pdfFileInput");

fileInput.addEventListener("change", function(event) {
  const file = event.target.files[0];

  converterPDFParaImagens(file).then(function(zipContent) {
    const url = URL.createObjectURL(zipContent);
    const a = document.createElement("a");
    a.href = url;
    a.download = "imagens.zip";
    a.click();
    setTimeout(function() {
      URL.revokeObjectURL(url);
    }, 100);
  }).catch(function(error) {
    console.error(error);
  });
});
	</script>

</body>
</html>